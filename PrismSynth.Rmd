---
title: "PrismLows"
author: "A Hessl"
date: "1/3/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read and extract annual winter lows from PRISM Data



```{r setup}
rm(list=ls())
library(lubridate)
library(tidyverse)
```

```{r read.prism}
#call function read.prism.R
source('Functions/read.prism.R')
```

```{r min monT}
#Select one gridbox from the list of grids
pgrid <- dataFiles2[[2]]

## Minimum monthly temperatures
mon.min <- pgrid %>% group_by(year=year(pdate), month=month(pdate)) %>% summarize(m.min=min(tmin))

#add readable time variable for plotting
mon.min$pdate <- paste0(mon.min$year, "-", mon.min$month, "-1")
```

```{r plot min monT}
plot(as.Date(mon.min$pdate), mon.min$m.min, type='l')
```

```{r min.dur}
#Find duration of the low below a critical threshold
thresh <- 0
pgrid$thresh <- pgrid$tmax < thresh
runs <- rle(pgrid$thresh)

pgrid$runs <- rep(runs$lengths, runs$lengths) #add a new vector that tells the lengths and positions of the runs

#give each run a unique identifier to aggregate on
events <- length(runs$values)
pgrid$event.id <- rep(1:events, c(runs$lengths))
```

```{r events plot}
#Events below threshold (TRUE) are kept, group by year and month
event.dur <- pgrid[pgrid$thresh %in% 'TRUE',] 

pgrid$year <- year(pgrid$pdate)
pgrid$month <- month(pgrid$pdate)
pgrid$day <- day(pgrid$pdate)

thresh.event <- pgrid[pgrid$thresh %in% 'TRUE', -c(1:5)] 
event.dur <- aggregate(thresh.event, by=list(thresh.event$event.id), min)

```


```{r plot durations}
barplot(event.dur$runs, names=event.dur$year, ylab="Duration (days)", xlab="Year")

```

But need to fix xaxis as differing number of events per year.  
Add at least blanks for months with no events
Stacked barplot for each year

```{r stacked events per year}
#Reshape the data from long to wide
dur.year <- event.dur[,c(3:5)]


x <- unstack(dur.year, dur.year$runs~dur.year$year) #ok? but a list



#to try:
barplot(data, col=colors()[c(23,89,12)] , border="white", space=0.04, font.axis=2, xlab="group")

```
